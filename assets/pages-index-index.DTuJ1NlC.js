import{$ as t,g as a,s as e,n as s,r as i,p as r,e as o,w as c,i as n,o as l,j as d,f as u,t as p,h,q as f,u as m,F as g,v as y,l as k,x as _}from"./index-D1azYyZI.js";import{r as v,_ as S}from"./qiun-data-charts.BjsE4O9X.js";import{C as D}from"./CustomNavBar.CZ4sq6xv.js";import{_ as w}from"./_plugin-vue_export-helper.BCo6x5W8.js";const b=w({components:{CustomNavBar:D},data:()=>({stats:{totalMaterials:0,lowStockWarnings:0,totalStock:0},recentActivities:[{type:"in",name:"ABS塑料粒入库",time:"2小时前",amount:"+50kg"}],navBarHeight:64,chartData:{categories:[],series:[]},chartOpts:{padding:[15,15,0,5],legend:{show:!0,position:"bottom",itemGap:10},xAxis:{disableGrid:!0,rotateLabel:!1,fontColor:"#666666",fontSize:10},yAxis:{data:[{min:0}]},extra:{column:{type:"group",width:30,activeBgColor:"#000000",activeBgOpacity:.08}}},top5Materials:[],stockRecords:[]}),onLoad(){this.fetchDashboardData(),this.getNavBarHeight(),this.fetchTop5Materials()},methods:{getNavBarHeight(){t("updateNavBarHeight",(t=>{this.navBarHeight=t}));try{const t=a("navBarHeight");t&&(this.navBarHeight=t)}catch(e){}},navigateToInventory(){e({url:"/pages/inventory/index"})},async fetchDashboardData(){try{const a=await s.callFunction({name:"material",data:{action:"getStockStats"}});if(a.result&&0===a.result.code){const{totalStock:t,lowStockCount:e}=a.result.data;this.stats.totalStock=t||0,this.stats.lowStockWarnings=e||0;const i=await s.callFunction({name:"material",data:{action:"getMaterials",data:{page:1,pageSize:1}}});i.result&&0===i.result.code&&(this.stats.totalMaterials=i.result.data.total||0)}try{const t=await s.callFunction({name:"stock-record",data:{action:"getStockRecords",data:{page:1,pageSize:10,startDate:Date.now()-6048e5,endDate:Date.now()}}});if(console.log("出入库记录响应:",t),t.result&&0===t.result.code&&t.result.data.records){const a=t.result.data.records;this.recentActivities=a.map((t=>{let a=t.quantity,e="t";return t.quantity>0&&t.quantity<.001?(a=1e3*t.quantity,e="kg"):a=Number.isInteger(t.quantity)?t.quantity:t.quantity.toFixed(1),{type:t.type,name:`${t.material_info&&t.material_info.name?t.material_info.name:"原料"} ${"in"===t.type?"入库":"出库"}`,time:this.formatTime(t.date),amount:`${"in"===t.type?"+":"-"}${a}${e}`,operator:t.operator_info&&t.operator_info.nickname?t.operator_info.nickname:"系统",remark:t.remark&&t.remark.text?t.remark.text:""}})),this.recentActivities=this.recentActivities.slice(0,5)}}catch(t){console.error("获取活动记录失败",t)}}catch(t){console.error("获取仪表盘数据失败",t)}},async fetchTop5Materials(){try{const t=await s.callFunction({name:"material",data:{action:"getMaterials",data:{page:1,pageSize:100}}});if(t.result&&0===t.result.code){const a=t.result.data.materials||[];this.top5Materials=a.sort(((t,a)=>a.stock-t.stock)).slice(0,5),await this.fetchStockRecords()}}catch(t){console.error("获取前5种原料失败",t)}},async fetchStockRecords(){if(0!==this.top5Materials.length)try{const t=Date.now()-2592e6,a=this.top5Materials.map((t=>t._id)),e=await s.callFunction({name:"stock-record",data:{action:"getStockRecords",data:{page:1,pageSize:1e3,startDate:t,endDate:Date.now()}}});if(e.result&&0===e.result.code){const t=e.result.data.records||[];this.stockRecords=t.filter((t=>a.includes(t.material_id))),this.processChartData()}}catch(t){console.error("获取库存记录失败",t)}},processChartData(){if(0===this.top5Materials.length||0===this.stockRecords.length)return void(this.chartData={categories:["暂无数据"],series:[{name:"入库量",data:[0]},{name:"出库量",data:[0]}]});const t=this.top5Materials.map((t=>t.name.substring(0,3))),a=[],e=[];for(const s of this.top5Materials){const t=this.stockRecords.filter((t=>t.material_id===s._id)),i=t.filter((t=>"in"===t.type)).reduce(((t,a)=>t+a.quantity),0),r=t.filter((t=>"out"===t.type)).reduce(((t,a)=>t+a.quantity),0);a.push(parseFloat(i.toFixed(2))),e.push(parseFloat(r.toFixed(2)))}this.chartData={categories:t,series:[{name:"入库量",data:a,color:"#5b79f1"},{name:"出库量",data:e,color:"#52c41a"}]}},formatTime(t){if(!t)return"未知时间";const a=Date.now()-t;if(a<36e5){return`${Math.floor(a/6e4)||1}分钟前`}if(a<864e5){return`${Math.floor(a/36e5)}小时前`}if(a<2592e6){return`${Math.floor(a/864e5)}天前`}const e=new Date(t);return`${e.getMonth()+1}月${e.getDate()}日`}}},[["render",function(t,a,e,s,D,w){const b=i("custom-nav-bar"),x=k,M=n,B=v(r("qiun-data-charts"),S);return l(),o(M,{class:"index-container"},{default:c((()=>[d(b,{title:"首页"}),d(M,{class:"page-content",style:y({paddingTop:D.navBarHeight+30+"px"})},{default:c((()=>[d(M,{class:"stats-cards"},{default:c((()=>[d(M,{class:"stat-card purple",onClick:w.navigateToInventory},{default:c((()=>[d(M,{class:"stat-number-container"},{default:c((()=>[d(x,{class:"stat-number-integer"},{default:c((()=>[u(p(D.stats.totalStock.toString().split(".")[0]),1)])),_:1}),D.stats.totalStock.toString().includes(".")?(l(),o(x,{key:0,class:"stat-number-decimal"},{default:c((()=>[u(p("."+D.stats.totalStock.toString().split(".")[1]),1)])),_:1})):h("",!0)])),_:1}),d(x,{class:"stat-label"},{default:c((()=>[u("总原料数(吨)")])),_:1})])),_:1},8,["onClick"]),d(M,{class:"stat-card purple",onClick:w.navigateToInventory},{default:c((()=>[d(x,{class:"stat-number"},{default:c((()=>[u(p(D.stats.lowStockWarnings),1)])),_:1}),d(x,{class:"stat-label"},{default:c((()=>[u("低库存警告")])),_:1})])),_:1},8,["onClick"])])),_:1}),d(M,{class:"chart-card"},{default:c((()=>[d(M,{class:"card-title"},{default:c((()=>[u("近30天库存趋势（吨）")])),_:1}),d(M,{class:"chart-container"},{default:c((()=>[d(B,{type:"column",opts:D.chartOpts,chartData:D.chartData,canvas2d:!0,canvasId:"stockTrendChart"},null,8,["opts","chartData"])])),_:1})])),_:1}),d(M,{class:"activity-card"},{default:c((()=>[d(M,{class:"card-title"},{default:c((()=>[u("最近活动")])),_:1}),(l(!0),f(g,null,m(D.recentActivities,((t,a)=>(l(),o(M,{class:"activity-item",key:a},{default:c((()=>[d(M,{class:"activity-left"},{default:c((()=>[d(M,{class:"activity-icon blue"},{default:c((()=>[d(x,{class:"icon-text"},{default:c((()=>[u(p("in"===t.type?"↓":"↑"),1)])),_:2},1024)])),_:2},1024),d(M,{class:"activity-info"},{default:c((()=>[d(x,{class:"activity-title"},{default:c((()=>[u(p(t.name),1)])),_:2},1024),d(M,{class:"activity-details"},{default:c((()=>[d(x,{class:"activity-time"},{default:c((()=>[u(p(t.time),1)])),_:2},1024),"系统"!==t.operator?(l(),o(x,{key:0,class:"activity-operator"},{default:c((()=>[u("• "+p(t.operator),1)])),_:2},1024)):h("",!0)])),_:2},1024),t.remark?(l(),o(x,{key:0,class:"activity-remark"},{default:c((()=>[u(p(t.remark),1)])),_:2},1024)):h("",!0)])),_:2},1024)])),_:2},1024),d(x,{class:_(["activity-amount",{increase:"in"===t.type,decrease:"out"===t.type}])},{default:c((()=>[u(p(t.amount),1)])),_:2},1032,["class"])])),_:2},1024)))),128))])),_:1})])),_:1},8,["style"])])),_:1})}],["__scopeId","data-v-3709817b"]]);export{b as default};
