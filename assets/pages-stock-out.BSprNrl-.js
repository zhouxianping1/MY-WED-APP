import{$ as t,g as a,Q as e,n as l,b as i,R as n,N as s,r as o,e as r,w as c,i as u,o as d,j as h,f,t as m,h as g,v as p,P as _,l as v,I as y,S as k,m as M}from"./index-D1azYyZI.js";import{C}from"./CustomNavBar.CZ4sq6xv.js";import{_ as b}from"./_plugin-vue_export-helper.BCo6x5W8.js";const x=b({components:{CustomNavBar:C},data(){return{navBarHeight:64,materialOptions:[],materialIndex:0,selectedMaterial:null,quantity:"",date:this.formatDate(new Date),remark:"",loading:!1,unitOptions:["kg","t"],unitIndex:-1,displayUnit:"请选择单位"}},onLoad(){this.getNavBarHeight(),this.fetchMaterials()},methods:{getNavBarHeight(){t("updateNavBarHeight",(t=>{this.navBarHeight=t}));try{const t=a("navBarHeight");t&&(this.navBarHeight=t)}catch(e){}},async fetchMaterials(){var t;try{e({title:"加载中"});const a=await l.callFunction({name:"material",data:{action:"getMaterials",data:{page:1,pageSize:100}}});a.result&&0===a.result.code?(this.materialOptions=a.result.data.materials||[],this.materialOptions.length>0&&(this.selectedMaterial=this.materialOptions[0])):i({title:(null==(t=a.result)?void 0:t.msg)||"获取原料列表失败",icon:"none"})}catch(a){console.error("获取原料列表失败",a),i({title:"获取原料列表失败",icon:"none"})}finally{n()}},onMaterialChange(t){const a=t.detail.value;this.materialIndex=a,this.selectedMaterial=this.materialOptions[a]},onUnitChange(t){const a=t.detail.value;this.unitIndex=a,this.displayUnit=this.unitOptions[a]},onDateChange(t){this.date=t.detail.value},formatDate:t=>`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`,async handleSubmit(){var t;if(!this.selectedMaterial)return i({title:"请选择原料",icon:"none"});if(!this.quantity||isNaN(Number(this.quantity))||Number(this.quantity)<=0)return i({title:"请输入有效的出库数量",icon:"none"});if(-1===this.unitIndex)return i({title:"请选择单位",icon:"none"});let a=Number(this.quantity);if("kg"===this.displayUnit&&(a/=1e3),a>this.selectedMaterial.stock)return i({title:"出库数量不能大于当前库存",icon:"none"});if(!this.date)return i({title:"请选择出库日期",icon:"none"});try{this.loading=!0,e({title:"提交中"});const o=await l.callFunction({name:"stock-record",data:{action:"addStockRecord",data:{material_id:this.selectedMaterial._id,quantity:a,type:"out",remark:{text:`备注: ${this.remark||"无"}`}}}});o.result&&0===o.result.code?(i({title:"出库成功",icon:"success"}),setTimeout((()=>{s()}),1500)):i({title:(null==(t=o.result)?void 0:t.msg)||"出库失败",icon:"none"})}catch(o){console.error("出库操作失败",o),i({title:"出库操作失败",icon:"none"})}finally{this.loading=!1,n()}},handleCancel(){s()}}},[["render",function(t,a,e,l,i,n){const s=o("custom-nav-bar"),C=u,b=_,x=v,N=y,B=k,q=M;return d(),r(C,{class:"stock-out-container"},{default:c((()=>[h(s,{title:"出库操作",showBack:!0}),h(C,{class:"page-content",style:p({paddingTop:i.navBarHeight+20+"px"})},{default:c((()=>[h(C,{class:"form-section"},{default:c((()=>[h(C,{class:"section-title"},{default:c((()=>[f("选择原料")])),_:1}),h(C,{class:"input-box"},{default:c((()=>[h(b,{onChange:n.onMaterialChange,value:i.materialIndex,range:i.materialOptions,"range-key":"name"},{default:c((()=>[h(C,{class:"picker-value"},{default:c((()=>[f(m(i.selectedMaterial?i.selectedMaterial.name:"请选择原料/Vui lòng chọn nguyên liệu"),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1}),i.selectedMaterial?(d(),r(C,{key:0,class:"form-section"},{default:c((()=>[h(C,{class:"section-title"},{default:c((()=>[f("原料编号")])),_:1}),h(C,{class:"input-box"},{default:c((()=>[h(C,{class:"readonly-value"},{default:c((()=>[f(m(i.selectedMaterial.code||"无编号"),1)])),_:1})])),_:1})])),_:1})):g("",!0),i.selectedMaterial?(d(),r(C,{key:1,class:"info-card"},{default:c((()=>[h(C,{class:"section-title"},{default:c((()=>[f("当前库存信息")])),_:1}),h(C,{class:"info-row"},{default:c((()=>[h(x,{class:"info-label"},{default:c((()=>[f("当前库存:")])),_:1}),h(x,{class:"info-value"},{default:c((()=>[f(m(i.selectedMaterial.stock)+m(i.selectedMaterial.unit),1)])),_:1})])),_:1}),h(C,{class:"info-row"},{default:c((()=>[h(x,{class:"info-label"},{default:c((()=>[f("存储位置:")])),_:1}),h(x,{class:"info-value"},{default:c((()=>[f(m(i.selectedMaterial.location),1)])),_:1})])),_:1}),h(C,{class:"info-row"},{default:c((()=>[h(x,{class:"info-label"},{default:c((()=>[f("最低库存:")])),_:1}),h(x,{class:"info-value"},{default:c((()=>[f(m(i.selectedMaterial.min_stock_warning)+m(i.selectedMaterial.unit),1)])),_:1})])),_:1})])),_:1})):g("",!0),h(C,{class:"form-section"},{default:c((()=>[h(C,{class:"section-title"},{default:c((()=>[f("出库数量")])),_:1}),h(C,{class:"quantity-row"},{default:c((()=>[h(C,{class:"input-box quantity-input"},{default:c((()=>[h(N,{type:"digit",modelValue:i.quantity,"onUpdate:modelValue":a[0]||(a[0]=t=>i.quantity=t),placeholder:"请输入出库数量 / Nhập số lượng xuất kho"},null,8,["modelValue"])])),_:1}),h(C,{class:"unit-selector"},{default:c((()=>[h(b,{onChange:n.onUnitChange,value:i.unitIndex,range:i.unitOptions},{default:c((()=>[h(C,{class:"unit-display"},{default:c((()=>[f(m(i.displayUnit),1)])),_:1})])),_:1},8,["onChange","value","range"])])),_:1})])),_:1})])),_:1}),h(C,{class:"form-section"},{default:c((()=>[h(C,{class:"section-title"},{default:c((()=>[f("出库日期")])),_:1}),h(C,{class:"input-box date-picker"},{default:c((()=>[h(b,{mode:"date",value:i.date,onChange:n.onDateChange},{default:c((()=>[h(C,{class:"picker-value"},{default:c((()=>[f(m(i.date||"年 /月/日"),1)])),_:1})])),_:1},8,["value","onChange"]),h(x,{class:"calendar-icon"},{default:c((()=>[f("📅")])),_:1})])),_:1})])),_:1}),h(C,{class:"form-section"},{default:c((()=>[h(C,{class:"section-title"},{default:c((()=>[f("备注")])),_:1}),h(C,{class:"input-box"},{default:c((()=>[h(B,{modelValue:i.remark,"onUpdate:modelValue":a[1]||(a[1]=t=>i.remark=t),placeholder:"请输入备注信息 / Nhập thông tin ghi chú","auto-height":""},null,8,["modelValue"])])),_:1})])),_:1}),h(C,{class:"btn-group"},{default:c((()=>[h(q,{class:"btn-primary",onClick:n.handleSubmit},{default:c((()=>[f("确认出库")])),_:1},8,["onClick"]),h(q,{class:"btn-secondary",onClick:n.handleCancel},{default:c((()=>[f("取消")])),_:1},8,["onClick"])])),_:1})])),_:1},8,["style"])])),_:1})}],["__scopeId","data-v-053b1406"]]);export{x as default};
