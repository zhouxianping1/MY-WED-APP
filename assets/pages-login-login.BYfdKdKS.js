import{n as a,a as t,g as e,s,c as n,b as i,d as l,e as o,w as r,i as c,o as u,f as d,h,j as m,k as p,l as g,I as f,m as w}from"./index-D1azYyZI.js";import{_ as b}from"./_plugin-vue_export-helper.BCo6x5W8.js";function _(){return(navigator.userAgent||"").includes("Zalo")||window.location.href.includes("zalo")}const v=b({data:()=>({userName:"",avatarUrl:"",defaultAvatar:"/static/logo.png",loading:!1,isFromZalo:!1}),onLoad(){this.isFromZalo=_();const a=e("userInfo");a&&a.openid&&s({url:"/pages/index/index"})},onShow(){const a=e("lastUserName");a&&(this.userName=a)},methods:{chooseAvatar(){n({count:1,sizeType:["compressed"],success:a=>{this.avatarUrl=a.tempFilePaths[0]}})},async onSubmit(){if(this.userName.trim()){this.loading=!0;try{const t=this.avatarUrl||this.defaultAvatar,e=await async function(t,e){if(!t)throw new Error("昵称不能为空 / Tên không được để trống");let s="";if(e&&"/static/logo.png"!==e)try{const t=await new Promise(((a,t)=>{uni.getFileSystemManager().readFile({filePath:e,encoding:"base64",success:t=>a(t.data),fail:t})})),n=await a.callFunction({name:"user",data:{action:"uploadImage",data:{fileContent:t,fileType:e.split(".").pop()||"jpg"}}});0===n.result.code&&(s=n.result.data.fileID||n.result.data.url||"")}catch(i){console.warn("头像上传失败，使用默认头像",i)}const{result:n}=await a.callFunction({name:"user",data:{action:"simpleLogin",data:{nickname:t,avatar:s}}});return n}(this.userName.trim(),t);if(0!==e.code)throw new Error(e.msg||"登录失败");l("userInfo",e.data.userInfo),l("lastUserName",this.userName.trim()),i({icon:"success",title:this.isFromZalo?"Đăng nhập thành công":"登录成功"}),setTimeout((()=>{s({url:"/pages/index/index"})}),1500)}catch(t){console.error("登录错误:",t),i({icon:"none",title:this.isFromZalo?"Đăng nhập thất bại":"登录失败："+t.message})}finally{this.loading=!1}}else i({icon:"none",title:this.isFromZalo?"Vui lòng nhập biệt danh":"请填写昵称"})},backToZalo(){_()&&(window.history.length>1?window.history.back():t({url:"/pages/index/index"}))}}},[["render",function(a,t,e,s,n,i){const l=c,b=p,_=g,v=f,y=w;return u(),o(l,{class:"login-container"},{default:r((()=>[n.isFromZalo?(u(),o(l,{key:0,class:"back-to-zalo",onClick:i.backToZalo},{default:r((()=>[d(" ← Quay lại Zalo ")])),_:1},8,["onClick"])):h("",!0),m(l,{class:"title"},{default:r((()=>[d("原料仓库管理")])),_:1}),m(l,{class:"subtitle"},{default:r((()=>[d("内部管理系统 / Hệ thống quản lý nội bộ")])),_:1}),m(l,{class:"form-card"},{default:r((()=>[m(l,{class:"avatar-wrapper",onClick:i.chooseAvatar},{default:r((()=>[m(b,{src:n.avatarUrl||n.defaultAvatar,class:"avatar",mode:"aspectFill"},null,8,["src"]),m(_,{class:"avatar-tip"},{default:r((()=>[d("点击上传头像（可选）/ Chọn ảnh đại diện (tùy chọn)")])),_:1})])),_:1},8,["onClick"]),m(l,{class:"input-item"},{default:r((()=>[m(_,{class:"input-icon"},{default:r((()=>[d("👤")])),_:1}),m(v,{class:"nickname-input",type:"text",placeholder:"请输入昵称 / Nhập biệt danh",modelValue:n.userName,"onUpdate:modelValue":t[0]||(t[0]=a=>n.userName=a)},null,8,["modelValue"])])),_:1}),m(y,{class:"login-btn",type:"primary",loading:n.loading,onClick:i.onSubmit},{default:r((()=>[d(" 登录 / Đăng nhập ")])),_:1},8,["loading","onClick"])])),_:1}),m(l,{class:"login-tip"},{default:r((()=>[m(_,{class:"tip-text"},{default:r((()=>[d("首次使用请输入您的昵称")])),_:1}),m(_,{class:"tip-text"},{default:r((()=>[d("Lần đầu sử dụng, vui lòng nhập biệt danh của bạn")])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-7cb60b84"]]);export{v as default};
