import{y as a,n as t,b as e,N as o,e as s,w as l,i,o as n,j as r,f as c,t as d,l as m,I as u,P as f,m as h}from"./index-D1azYyZI.js";import{_ as g}from"./_plugin-vue_export-helper.BCo6x5W8.js";const p=g({data:()=>({statusBarHeight:0,loading:!1,categories:[],displayUnit:"kg",formData:{name:"",code:"",category:"",stock:"",unit:"kg",min_stock_warning:"",location:"",supplier:{name:"",address:""},remark:{text:"",images:[]}}}),onLoad(){const t=a();this.statusBarHeight=t.statusBarHeight||0,this.fetchCategories()},methods:{async fetchCategories(){try{const a=await t.callFunction({name:"material-category",data:{action:"getCategories"}});a.result&&0===a.result.code&&(this.categories=a.result.data.categories||[])}catch(a){console.error("获取分类失败",a)}},handleCategoryChange(a){const t=a.detail.value;this.categories[t]&&(this.formData.category=this.categories[t].name)},handleUnitChange(a){const t=["kg","t"][a.detail.value];this.displayUnit=t,this.formData.unit="t"},async submitForm(){var a;if(!this.formData.name)return void e({title:"请输入原料名称",icon:"none"});if(!this.formData.code)return void e({title:"请输入原料编号",icon:"none"});const s=this.formData.stock;this.formData.stock&&("kg"===this.displayUnit?this.formData.stock=parseFloat((parseFloat(this.formData.stock)/1e3).toFixed(2)):this.formData.stock=parseFloat(parseFloat(this.formData.stock).toFixed(2))),this.formData.min_stock_warning&&("kg"===this.displayUnit?this.formData.min_stock_warning=parseFloat((parseFloat(this.formData.min_stock_warning)/1e3).toFixed(2)):this.formData.min_stock_warning=parseFloat(parseFloat(this.formData.min_stock_warning).toFixed(2))),this.loading=!0;try{const i=await t.callFunction({name:"material",data:{action:"addMaterial",data:this.formData}});if(i.result&&0===i.result.code){const a=i.result.data.id,t=i.result.data.isUpdate||!1;if(s&&parseFloat(s)>0)try{await this.createStockRecord(a,s,t)}catch(l){console.error("创建入库记录失败",l)}e(t?{title:"原料已存在，库存已更新",icon:"success"}:{title:"添加成功",icon:"success"}),setTimeout((()=>{o()}),1500)}else e({title:(null==(a=i.result)?void 0:a.msg)||"添加失败",icon:"none"})}catch(i){e({title:"添加失败："+i.message,icon:"none"})}finally{this.loading=!1}},async createStockRecord(a,e,o=!1){const s={material_id:a,quantity:"kg"===this.displayUnit?parseFloat((parseFloat(e)/1e3).toFixed(2)):parseFloat(parseFloat(e).toFixed(2)),type:"in",remark:{text:o?"追加入库":"初始入库",images:[]}};return await t.callFunction({name:"stock-record",data:{action:"addStockRecord",data:s}})},goBack(){o()}}},[["render",function(a,t,e,o,g,p){const _=i,k=m,y=u,D=f,F=h;return n(),s(_,{class:"add-material-container"},{default:l((()=>[r(_,{class:"header"},{default:l((()=>[r(_,{class:"status-bar"}),r(_,{class:"nav-content"},{default:l((()=>[r(_,{class:"back-icon",onClick:p.goBack},{default:l((()=>[r(k,{class:"icon"},{default:l((()=>[c("←")])),_:1})])),_:1},8,["onClick"]),r(k,{class:"title"},{default:l((()=>[c("添加原料")])),_:1})])),_:1})])),_:1}),r(_,{class:"form-container"},{default:l((()=>[r(_,{class:"form-item"},{default:l((()=>[r(k,{class:"form-label"},{default:l((()=>[c("注塑原料名称")])),_:1}),r(y,{class:"form-input",type:"text",placeholder:"请输入注塑原料名称 / Nhập tên nguyên liệu",modelValue:g.formData.name,"onUpdate:modelValue":t[0]||(t[0]=a=>g.formData.name=a)},null,8,["modelValue"])])),_:1}),r(_,{class:"form-item"},{default:l((()=>[r(k,{class:"form-label"},{default:l((()=>[c("原料编号")])),_:1}),r(y,{class:"form-input",type:"text",placeholder:"请输入原料编号 / Nhập mã nguyên liệu",modelValue:g.formData.code,"onUpdate:modelValue":t[1]||(t[1]=a=>g.formData.code=a)},null,8,["modelValue"])])),_:1}),r(_,{class:"form-item"},{default:l((()=>[r(k,{class:"form-label"},{default:l((()=>[c("分类")])),_:1}),r(_,{class:"form-select"},{default:l((()=>[r(D,{mode:"selector",range:g.categories,"range-key":"name",onChange:p.handleCategoryChange},{default:l((()=>[r(_,{class:"picker-value"},{default:l((()=>[c(d(g.formData.category?g.formData.category:"选择分类Chọn phân loại")+" ",1),r(k,{class:"select-icon"},{default:l((()=>[c("▼")])),_:1})])),_:1})])),_:1},8,["range","onChange"])])),_:1})])),_:1}),r(_,{class:"form-item"},{default:l((()=>[r(k,{class:"form-label"},{default:l((()=>[c("入库数量")])),_:1}),r(y,{class:"form-input",type:"number",placeholder:"请输入数量 / Nhập số lượng",modelValue:g.formData.stock,"onUpdate:modelValue":t[2]||(t[2]=a=>g.formData.stock=a)},null,8,["modelValue"])])),_:1}),r(_,{class:"form-item"},{default:l((()=>[r(k,{class:"form-label"},{default:l((()=>[c("单位")])),_:1}),r(_,{class:"form-select"},{default:l((()=>[r(D,{mode:"selector",range:["kg","t"],onChange:p.handleUnitChange},{default:l((()=>[r(_,{class:"picker-value"},{default:l((()=>[c(d(g.displayUnit)+" ",1),r(k,{class:"select-icon"},{default:l((()=>[c("▼")])),_:1})])),_:1})])),_:1},8,["onChange"])])),_:1})])),_:1}),r(_,{class:"form-item"},{default:l((()=>[r(k,{class:"form-label"},{default:l((()=>[c("最低库存警告")])),_:1}),r(y,{class:"form-input",type:"number",placeholder:"请输入最低库存 / Nhập tồn kho tối thiểu",modelValue:g.formData.min_stock_warning,"onUpdate:modelValue":t[3]||(t[3]=a=>g.formData.min_stock_warning=a)},null,8,["modelValue"])])),_:1}),r(_,{class:"form-item"},{default:l((()=>[r(k,{class:"form-label"},{default:l((()=>[c("存储位置")])),_:1}),r(y,{class:"form-input",type:"text",placeholder:"如: A-01 / Ví dụ: A-01",modelValue:g.formData.location,"onUpdate:modelValue":t[4]||(t[4]=a=>g.formData.location=a)},null,8,["modelValue"])])),_:1}),r(F,{class:"submit-btn",type:"primary",loading:g.loading,onClick:p.submitForm},{default:l((()=>[c(" 保存 ")])),_:1},8,["loading","onClick"])])),_:1})])),_:1})}],["__scopeId","data-v-c6300ce0"]]);export{p as default};
